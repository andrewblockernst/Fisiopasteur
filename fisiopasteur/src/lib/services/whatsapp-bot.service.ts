"use server";

import type { TurnoWithRelations } from "@/types/database.types";
import { mapearTurnoParaBot } from "@/lib/utils/whatsapp.utils";

// Configuraci√≥n del bot
const BOT_URL = process.env.WHATSAPP_BOT_URL || 'https://fisiopasteur-whatsapp-bot-df9edfb46742.herokuapp.com';

// Interfaces para los datos del bot
interface TurnoDataForBot {
  pacienteNombre: string;
  pacienteApellido: string;
  telefono: string;
  fecha: string; // DD/MM/YYYY
  hora: string;  // HH:MM
  profesional: string;
  especialidad: string;
  turnoId: string;
  centroMedico?: string;
}

interface BotResponse {
  status: 'success' | 'error';
  message: string;
  turnoId?: string;
}

// =====================================
// üîß FUNCIONES AUXILIARES
// =====================================

/**
 * Realizar petici√≥n HTTP al bot
 */
async function realizarPeticionBot(endpoint: string, data: any): Promise<BotResponse> {
  try {
    const response = await fetch(`${BOT_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      // Intentar obtener m√°s detalles del error
      let errorMessage = `HTTP Error: ${response.status}`;
      try {
        const errorData = await response.json();
        if (errorData.message) {
          errorMessage += ` - ${errorData.message}`;
        }
      } catch {
        // Si no se puede parsear el error, usar el mensaje b√°sico
      }
      
      throw new Error(errorMessage);
    }

    const result = await response.json();
    return result as BotResponse;
  } catch (error) {
    console.error(`Error en petici√≥n al bot (${endpoint}):`, error);
    
    // Manejo espec√≠fico de errores comunes
    if (error instanceof Error) {
      if (error.message.includes('fetch')) {
        return {
          status: 'error',
          message: 'No se pudo conectar con el bot de WhatsApp. Verifique la conexi√≥n.'
        };
      }
      if (error.message.includes('500')) {
        return {
          status: 'error',
          message: 'El bot de WhatsApp no est√° autenticado. Escanee el c√≥digo QR.'
        };
      }
      return {
        status: 'error',
        message: error.message
      };
    }
    
    return {
      status: 'error',
      message: 'Error desconocido al comunicarse con el bot'
    };
  }
}

// =====================================
// üì± FUNCIONES PRINCIPALES DEL BOT
// =====================================

/**
 * Enviar confirmaci√≥n de turno por WhatsApp
 */
export async function enviarConfirmacionTurno(
  turnoOrTelefono: TurnoWithRelations | string,
  nombrePaciente?: string,
  nombreEspecialista?: string,
  fecha?: string,
  hora?: string
): Promise<BotResponse> {
  // Si el primer par√°metro es un string, es la sobrecarga simple
  if (typeof turnoOrTelefono === 'string') {
    console.log('üì± Enviando confirmaci√≥n individual por WhatsApp...');
    
    const telefono = turnoOrTelefono;
    if (!telefono || !nombrePaciente || !nombreEspecialista || !fecha || !hora) {
      return {
        status: 'error',
        message: 'Faltan datos requeridos para enviar la confirmaci√≥n'
      };
    }

    const datosBot = {
      pacienteNombre: nombrePaciente.split(' ')[0] || nombrePaciente,
      pacienteApellido: nombrePaciente.split(' ').slice(1).join(' ') || '',
      telefono,
      fecha,
      hora,
      profesional: nombreEspecialista,
      especialidad: 'Fisioterapia',
      turnoId: `temp_${Date.now()}`,
      centroMedico: 'Fisiopasteur'
    };

    const resultado = await realizarPeticionBot('/api/turno/confirmar', datosBot);
    
    if (resultado.status === 'success') {
      console.log(`‚úÖ Confirmaci√≥n individual enviada a ${telefono}`);
    } else {
      console.error(`‚ùå Error enviando confirmaci√≥n individual: ${resultado.message}`);
    }
    
    return resultado;
  }

  // Si es un objeto TurnoWithRelations, usar la funci√≥n original
  const turno = turnoOrTelefono;
  console.log('üì± Enviando confirmaci√≥n de turno por WhatsApp...');
  
  // Validar datos b√°sicos
  if (!turno.paciente?.telefono) {
    return {
      status: 'error',
      message: 'El paciente no tiene n√∫mero de tel√©fono registrado'
    };
  }

  const datosBot = mapearTurnoParaBot(turno);
  const resultado = await realizarPeticionBot('/api/turno/confirmar', datosBot);
  
  if (resultado.status === 'success') {
    console.log(`‚úÖ Confirmaci√≥n enviada a ${turno.paciente.telefono} para turno ${turno.id_turno}`);
  } else {
    console.error(`‚ùå Error enviando confirmaci√≥n: ${resultado.message}`);
  }
  
  return resultado;
}

/**
 * Enviar recordatorio de turno por WhatsApp
 */
export async function enviarRecordatorioTurno(turno: TurnoWithRelations): Promise<BotResponse> {
  console.log('‚è∞ Enviando recordatorio de turno por WhatsApp...');
  
  // Validar datos b√°sicos
  if (!turno.paciente?.telefono) {
    return {
      status: 'error',
      message: 'El paciente no tiene n√∫mero de tel√©fono registrado'
    };
  }

  const datosBot = mapearTurnoParaBot(turno);
  const resultado = await realizarPeticionBot('/api/turno/recordatorio', datosBot);
  
  if (resultado.status === 'success') {
    console.log(`‚úÖ Recordatorio enviado a ${turno.paciente.telefono} para turno ${turno.id_turno}`);
  } else {
    console.error(`‚ùå Error enviando recordatorio: ${resultado.message}`);
  }
  
  return resultado;
}

/**
 * Enviar mensaje personalizado por WhatsApp
 */
export async function enviarMensajePersonalizado(
  telefono: string, 
  mensaje: string, 
  media?: string
): Promise<BotResponse> {
  console.log('üí¨ Enviando mensaje personalizado por WhatsApp...');
  
  const data = { telefono, mensaje, media };
  const resultado = await realizarPeticionBot('/api/mensaje/enviar', data);
  
  if (resultado.status === 'success') {
    console.log(`‚úÖ Mensaje enviado a ${telefono}`);
  } else {
    console.error(`‚ùå Error enviando mensaje: ${resultado.message}`);
  }
  
  return resultado;
}

/**
 * Verificar estado del bot de WhatsApp
 */
export async function verificarEstadoBot(): Promise<boolean> {
  try {
    const response = await fetch(`${BOT_URL}/api/health`);
    
    if (!response.ok) return false;
    
    const result = await response.json();
    return result.status === 'ok';
  } catch (error) {
    console.error('Error verificando estado del bot:', error);
    return false;
  }
}

/**
 * Analizar patrones de turnos para crear mensaje inteligente
 */
function analizarPatronesTurnos(turnos: any[]) {
  const diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
  
  // Agrupar turnos por d√≠a de la semana y horario
  const patronesPorDiaYHora: Record<string, Set<string>> = {};
  
  turnos.forEach(turno => {
    const fecha = new Date(turno.fecha);
    const diaSemana = diasSemana[fecha.getDay()];
    const hora = turno.hora || turno.hora_inicio;
    const horaFormateada = hora.substring(0, 5); // "09:00:00" -> "09:00"
    
    const key = `${diaSemana}_${horaFormateada}`;
    if (!patronesPorDiaYHora[key]) {
      patronesPorDiaYHora[key] = new Set();
    }
    patronesPorDiaYHora[key].add(turno.fecha);
  });

  // Convertir a formato legible
  const patronesTexto: string[] = [];
  Object.keys(patronesPorDiaYHora).forEach(key => {
    const [dia, hora] = key.split('_');
    const cantidadTurnos = patronesPorDiaYHora[key].size;
    // Plural correcto para d√≠as de la semana
    const diaPlural = dia === 'mi√©rcoles' ? 'mi√©rcoles' : `${dia}s`;
    patronesTexto.push(`${diaPlural} a las ${hora}`);
  });

  return {
    patronesTexto,
    totalTurnos: turnos.length,
    diasUnicos: Object.keys(patronesPorDiaYHora).length
  };
}

/**
 * Enviar notificaci√≥n agrupada para m√∫ltiples turnos del mismo paciente
 */
export async function enviarNotificacionGrupal(
  telefono: string,
  nombrePaciente: string,
  turnos: any[]
): Promise<BotResponse> {
  console.log('üì± Enviando notificaci√≥n agrupada por WhatsApp...');
  
  if (!telefono || !nombrePaciente || !turnos || turnos.length === 0) {
    return {
      status: 'error',
      message: 'Faltan datos requeridos para enviar la notificaci√≥n agrupada'
    };
  }

  try {
    // Analizar patrones de turnos
    const analisis = analizarPatronesTurnos(turnos);
    
    // Crear mensaje inteligente basado en patrones
    let mensaje: string;
    
    if (analisis.totalTurnos <= 5) {
      // Para pocos turnos, mostrar fechas espec√≠ficas
      const fechasYHoras = turnos.map(turno => {
        const fecha = new Date(turno.fecha).toLocaleDateString('es-AR');
        const hora = (turno.hora || turno.hora_inicio).substring(0, 5);
        return `‚Ä¢ ${fecha} a las ${hora}`;
      });
      
      mensaje = `¬°Hola ${nombrePaciente}! üåü

Se han confirmado ${analisis.totalTurnos} turnos para ti:

${fechasYHoras.join('\n')}

Te esperamos en Fisiopasteur. ¬°Nos vemos pronto! üí™`;
    } else {
      // Para muchos turnos, mostrar patr√≥n de d√≠as
      mensaje = `¬°Hola ${nombrePaciente}! üåü

Se han confirmado tus turnos de Pilates:

${analisis.patronesTexto.map(p => `‚Ä¢ ${p}`).join('\n')}

Total: ${analisis.totalTurnos} clases programadas

Te esperamos en Fisiopasteur. ¬°Nos vemos pronto! üí™

_Recibir√°s recordatorios antes de cada clase._`;
    }

    // Enviar mensaje personalizado
    const resultado = await enviarMensajePersonalizado(telefono, mensaje);
    
    if (resultado.status === 'success') {
      console.log(`‚úÖ Notificaci√≥n agrupada enviada a ${telefono} para ${turnos.length} turnos`);
    } else {
      console.error(`‚ùå Error enviando notificaci√≥n agrupada: ${resultado.message}`);
    }
    
    return resultado;
  } catch (error) {
    console.error('Error preparando notificaci√≥n agrupada:', error);
    return {
      status: 'error',
      message: error instanceof Error ? error.message : 'Error desconocido'
    };
  }
}

